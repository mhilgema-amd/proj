#!/bin/bash

function setup_affinity ()
{
    #
    # Set the affinity
    #
    #
    AFFINITY="${HOME}/bin/my_affinity.exe -v -n ${PPN} -t ${NTHREADS}"

    if [ ${HAVE_AMD} -gt 0 ]; then
        case "${CCD}" in
            1)
                case "${L3}" in
                    1)
                        case "${SMT}" in
                            0)
                                CPULIST="0-7:4,64-71:4"
                                ;;
                            1)
                                CPULIST="0,128,4,132,64,192,68,196"
                                ;;
                        esac
                        ;;
                    2)
                        case "${SMT}" in
                            0)
                                CPULIST="0-7:2,64-71:2"
                                ;;
                            1)
                                CPULIST="0,128,1,129,4,132,5,133,64,192,65,193,68,196,69,197"
                                ;;
                        esac
                        ;;
                    3)
                        case "${SMT}" in
                            0)
                                CPULIST="0-2,4-6,64-66,68-70"
                                ;;
                            1)
                                CPULIST="0,128,1,129,2,130,4,132,5,133,6,134,64,192,65,193,66,194,68,196,69,197,70,198"
                                ;;
                        esac
                        ;;
                    4)
                        case "${SMT}" in
                            0)
                                CPULIST="0-7,64-71"
                                ;;
                            1)
                                CPULIST="0,128,1,129,2,130,3,131,4,132,5,133,6,134,7,64,192,65,193,66,194,67,195,68,196,69,197,70,198,71,199"
                                ;;
                        esac
                        ;;
                esac
                ;;
            2)
                case "${L3}" in
                    1)
                        case "${SMT}" in
                            0)
                                CPULIST="0-15:4,64-79:4"
                                ;;
                            1)
                                CPULIST="0,128,4,132,8,136,12,140,64,192,68,196,72,200,76,204"
                                ;;
                        esac
                        ;;
                    2)
                        case "${SMT}" in
                            0)
                                CPULIST="0-15:2,64-79:2"
                                ;;
                            1)
                                CPULIST="0,128,1,129,4,132,5,133,8,136,9,137,12,140,13,141,64,192,65,193,68,196,69,197,72,200,73,201,76,204,77,205"
                                ;;
                        esac
                        ;;
                    3)
                        case "${SMT}" in
                            0)
                                CPULIST="0-2,4-6,8-10,12-14,64-66,68-70,72-74,76-78"
                                ;;
                            1)
                                CPULIST="0,128,1,129,2,130,4,132,5,133,6,134,8,136,9,137,10,138,12,140,13,141,14,142,64,192,65,193,66,194,68,196,69,197,70,198,72,200,73,201,74,202,76,204,77,205,78,206"
                                ;;
                        esac
                        ;;
                    4)
                        case "${SMT}" in
                            0)
                                CPULIST="0-15,64-79"
                                ;;
                            1)
                                CPULIST="0,128,1,129,2,130,3,131,4,132,5,133,6,134,7,135,8,136,9,137,10,138,11,139,12,140,13,141,14,142,15,143,64,192,65,193,66,194,67,195,68,196,69,197,70,198,71,199,72,200,73,201,74,202,75,203,76,204,77,205,78,206,79,207"
                                ;;
                        esac
                        ;;
                esac
                ;;
            4)
                case "${L3}" in
                    1)
                        case "${SMT}" in
                            0)
                                CPULIST="0-31:4,64-95:4"
                                ;;
                            1)
                                CPULIST="0,128,4,132,8,136,12,140,16,144,20,148,24,152,28,156,64,192,68,196,72,200,76,204,80,208,84,212,88,216,92,220"
                                ;;
                        esac
                        ;;
                    2)
                        case "${SMT}" in
                            0)
                                CPULIST="0-31:2,64-95:2"
                                ;;
                            1)
                                CPULIST="0,128,1,129,4,132,5,133,8,136,9,137,12,140,13,141,16,144,17,145,20,148,21,149,24,152,25,153,28,156,29,157,64,192,65,193,68,196,69,197,72,200,73,201,76,204,77,205,80,208,81,209,84,212,85,213,88,216,89,217,92,220,93,221"
                                ;;
                        esac
                        ;;
                    3)
                        case "${SMT}" in
                            0)
                                CPULIST="0-2,4-6,8-10,12-14,16-18,20-22,24-26,28-30,64-66,68-70,72-74,76-78,80-82,84-86,88-90,92-94"
                                ;;
                            1)
                                CPULIST="0,128,1,129,2,130,4,132,5,133,6,134,8,136,9,137,10,138,12,140,13,141,14,142,16,144,17,145,18,146,20,148,21,149,22,150,24,152,25,153,26,154,28,156,29,157,30,158,64,192,65,193,66,194,68,196,69,197,70,198,72,200,73,201,74,202,76,204,77,205,78,206,80,208,81,209,82,210,84,212,85,213,86,214,88,216,89,217,90,218,92,220,93,221,94,222"
                                ;;
                        esac
                        ;;
                    4)
                        case "${SMT}" in
                            0)
                                CPULIST="0-31,64-95"
                                ;;
                            1)
                                CPULIST="0,128,1,129,2,130,3,131,4,132,5,133,6,134,7,135,8,136,9,137,10,138,11,139,12,140,13,141,14,142,15,143,16,144,17,145,18,146,19,147,20,148,21,149,22,150,23,151,24,152,25,153,26,154,27,155,28,156,29,157,30,158,31,159,64,192,65,193,66,194,67,195,68,196,69,197,70,198,71,199,72,200,73,201,74,202,75,203,76,204,77,205,78,206,79,207,80,208,81,209,82,210,83,211,84,212,85,213,86,214,87,215,88,216,89,217,90,218,91,219,92,220,93,221,94,222,95,223"
                                ;;
                        esac
                        ;;
                esac
                ;;
            6)
                case "${L3}" in
                    1)
                        case "${SMT}" in
                            0)
                                CPULIST="0-47:4,64-111:4"
                                ;;
                            1)
                                CPULIST="0,128,4,132,8,136,12,140,16,144,20,148,24,152,28,156,32,160,36,164,40,168,44,172,64,192,68,196,72,200,76,204,80,208,84,212,88,216,92,220,96,224,100,228,104,232,108,236"
                                ;;
                        esac
                        ;;
                    2)
                        case "${SMT}" in
                            0)
                                CPULIST="0-47:2,64-111:2"
                                ;;
                            1)
                                CPULIST="0,128,1,129,4,132,5,133,8,136,9,137,12,140,13,141,16,144,17,145,20,148,21,149,24,152,25,153,28,156,29,157,32,160,33,161,36,164,37,165,40,168,41,169,44,172,45,173,64,192,65,193,68,196,69,197,72,200,73,201,76,204,77,205,80,208,81,209,84,212,85,213,88,216,89,217,92,220,93,221,96,224,97,225,100,228,101,229,104,232,105,233,108,236,109,237"
                                ;;
                        esac
                        ;;
                    3)
                        case "${SMT}" in
                            0)
                                CPULIST="0-2,4-6,8-10,12-14,16-18,20-22,24-26,28-30,32-34,36-38,40-42,44-46,64-66,68-70,72-74,76-78,80-82,84-86,88-90,92-94,96-98,100-102,104-106,108-110"
                                ;;
                            1)
                                CPULIST="0,128,1,129,2,130,4,132,5,133,6,134,8,136,9,137,10,138,12,140,13,141,14,142,16,144,17,145,18,146,20,148,21,149,22,150,24,152,25,153,26,154,28,156,29,157,30,158,32,160,33,161,34,162,36,164,37,165,38,166,40,168,41,169,42,170,44,172,45,173,46,174,64,192,65,193,66,194,68,196,69,197,70,198,72,200,73,201,74,202,76,204,77,205,78,206,80,208,81,209,82,210,84,212,85,213,86,214,88,216,89,217,90,218,92,220,93,221,94,222,96,224,97,225,98,226,100,228,101,229,102,230,104,232,105,233,106,234,108,236,109,237,110,238"
                                ;;
                        esac
                        ;;
                    4)
                        case "${SMT}" in
                            0)
                                CPULIST="0-47,64-111"
                                ;;
                            1)
                                CPULIST="0,128,1,129,2,130,3,131,4,132,5,133,6,134,7,135,8,136,9,137,10,138,11,139,12,140,13,141,14,142,15,143,16,144,17,145,18,146,19,147,20,148,21,149,22,150,23,151,24,152,25,153,26,154,27,155,28,156,29,157,30,158,31,159,32,160,33,161,34,162,35,163,36,164,37,165,38,166,39,167,40,168,41,169,42,170,43,171,44,172,45,173,46,174,47,175,64,192,65,193,66,194,67,195,68,196,69,197,70,198,71,199,72,200,73,201,74,202,75,203,76,204,77,205,78,206,79,207,80,208,81,209,82,210,83,211,84,212,85,213,86,214,87,215,88,216,89,217,90,218,91,219,92,220,93,221,94,222,95,223,96,224,97,225,98,226,99,227,100,228,101,229,102,230,103,231,104,232,105,233,106,234,107,235,108,236,109,237,110,238,111,239"
                                ;;
                        esac
                        ;;
                esac
                ;;
            8)
                case "${L3}" in
                    1)
                        case "${SMT}" in
                            0)
                                CPULIST="0-127:4"
                                ;;
                            1)
                                CPULIST="0,128,4,132,8,136,12,140,16,144,20,148,24,152,28,156,32,160,36,164,40,168,44,172,48,176,52,180,56,184,60,188,64,192,68,196,72,200,76,204,80,208,84,212,88,216,92,220,96,224,100,228,104,232,108,236,112,240,116,244,120,248,124,252"
                                ;;
                        esac
                        ;;
                    2)
                        case "${SMT}" in
                            0)
                                CPULIST="0-127:2"
                                ;;
                            1)
                                CPULIST="0,128,1,129,4,132,5,133,8,136,9,137,12,140,13,141,16,144,17,145,20,148,21,149,24,152,25,153,28,156,29,157,32,160,33,161,36,164,37,165,40,168,41,169,44,172,45,173,48,176,49,177,52,180,53,181,56,184,57,185,60,188,61,189,64,192,65,193,68,196,69,197,72,200,73,201,76,204,77,205,80,208,81,209,84,212,85,213,88,216,89,217,92,220,93,221,96,224,97,225,100,228,101,229,104,232,105,233,108,236,109,237,112,240,113,241,116,244,117,245,120,248,121,249,124,252,125,253"
                                ;;
                        esac
                        ;;
                    3)
                        case "${SMT}" in
                            0)
                                CPULIST="0,1,2,4,5,6,8,9,10,12,13,14,16,17,18,20,21,22,24,25,26,28,29,30,32,33,34,36,37,38,40,41,42,44,45,46,48,49,50,52,53,54,56,57,58,60,61,62,64,65,66,68,69,70,72,73,74,76,77,78,80,81,82,84,85,86,88,89,90,92,93,94,96,97,98,100,101,102,104,105,106,108,109,110,112,113,114,116,117,118,120,121,122,124,125,126"
                                ;;
                            1)
                                CPULIST="0,128,1,129,2,130,4,132,5,133,6,134,8,136,9,137,10,138,12,140,13,141,14,142,16,144,17,145,18,146,20,148,21,149,22,150,24,152,25,153,26,154,28,156,29,157,30,158,32,160,33,161,34,162,36,164,37,165,38,166,40,168,41,169,42,170,44,172,45,173,46,174,48,176,49,177,50,178,52,180,53,181,54,182,56,184,57,185,58,186,60,188,61,189,62,190,64,192,65,193,66,194,68,196,69,197,70,198,72,200,73,201,74,202,76,204,77,205,78,206,80,208,81,209,82,210,84,212,85,213,86,214,88,216,89,217,90,218,92,220,93,221,94,222,96,224,97,225,98,226,100,228,101,229,102,230,104,232,105,233,106,234,108,236,109,237,110,238,112,240,113,241,114,242,116,244,117,245,118,246,120,248,121,249,122,250,124,252,125,253,126,254"
                                ;;
                        esac
                        ;;
                    4)
                        case "${SMT}" in
                            0)
                                CPULIST="0-127"
                                ;;
                            1)
                                CPULIST="0,128,1,129,2,130,3,131,4,132,5,133,6,134,7,135,8,136,9,137,10,138,11,139,12,140,13,141,14,142,15,143,16,144,17,145,18,146,19,147,20,148,21,149,22,150,23,151,24,152,25,153,26,154,27,155,28,156,29,157,30,158,31,159,32,160,33,161,34,162,35,163,36,164,37,165,38,166,39,167,40,168,41,169,42,170,43,171,44,172,45,173,46,174,47,175,48,176,49,177,50,178,51,179,52,180,53,181,54,182,55,183,56,184,57,185,58,186,59,187,60,188,61,189,62,190,63,191,64,192,65,193,66,194,67,195,68,196,69,197,70,198,71,199,72,200,73,201,74,202,75,203,76,204,77,205,78,206,79,207,80,208,81,209,82,210,83,211,84,212,85,213,86,214,87,215,88,216,89,217,90,218,91,219,92,220,93,221,94,222,95,223,96,224,97,225,98,226,99,227,100,228,101,229,102,230,103,231,104,232,105,233,106,234,107,235,108,236,109,237,110,238,111,239,112,240,113,241,114,242,115,243,116,244,117,245,118,246,119,247,120,248,121,249,122,250,123,251,124,252,125,253,126,254,127,255"
                                ;;
                        esac
                        ;;
                esac
                ;;
        esac

        AFFINITY="${AFFINITY} -c ${CPULIST}"

    fi

    if [ ${HAVE_INTEL} -gt 0 ]; then
        AFFINITY="${AFFINITY}"
    fi
}
